<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Incident Dashboard</title>
  <style>
    body {
      margin: 0; font-family: "Segoe UI", sans-serif; background: #f4f6f8; color: #333;
    }
    header {
      background: #0077cc; color: white; padding: 15px 25px; font-size: 1.5em;
      font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .tabs {
      display: flex; background: #e9ecef; border-bottom: 1px solid #ccc;
    }
    .tab {
      padding: 10px 20px; cursor: pointer; font-weight: bold;
      border-right: 1px solid #ccc;
    }
    .tab.active {
      background: white; border-bottom: none;
    }
    .tab-content {
      display: none; padding: 20px;
    }
    .tab-content.active { display: block; }

    .filters {
      display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px;
    }
    input, select, button {
      padding: 8px; font-size: 14px;
    }
    button {
      background: #007BFF; color: white; border: none; cursor: pointer;
    }
    button:hover { background: #0056b3; }
    table {
      width: 100%; border-collapse: collapse; background: white;
    }
    th, td {
      border: 1px solid #ddd; padding: 8px; text-align: left;
    }
    th {
      background: #f0f0f0; position: sticky; top: 0;
    }
    tr:nth-child(even) { background: #f9f9f9; }

    iframe {
      border: none;
      width: 100%;
      height: 600px;
    }
  </style>
</head>
<body>

<header>📊 Incident Dashboard</header>

<div class="tabs">
  <div class="tab active" onclick="showTab('tab1')">📋 Incident Table</div>
  <div class="tab" onclick="showTab('tab2')">👷‍♂️ Man Hours</div>
  <div class="tab" onclick="showTab('tab3')">📈 Incident Rates</div>
  <div class="tab" onclick="showTab('tab4')">📊 Summary Charts</div>
</div>

<div class="tab-content active" id="tab1">
  <div class="filters">
    <input type="text" id="searchBox" placeholder="Search..." oninput="applyFilters()">
    <select id="filterClassification" onchange="applyFilters()"><option value="">All Classifications</option></select>
    <select id="filterOutcome" onchange="applyFilters()"><option value="">All Outcomes</option></select>
    <select id="filterJob" onchange="applyFilters()"><option value="">All Job #</option></select>
    <button onclick="init()">🔄 Refresh</button>
    <button onclick="exportCSV()">📥 Export</button>
  </div>

  <table id="dataTable">
    <thead></thead>
    <tbody></tbody>
  </table>
</div>

<div class="tab-content" id="tab2">
  <h3>👷 Man Hours by Subcontractor</h3>
  <p>Coming soon...</p>
</div>

<div class="tab-content" id="tab3">
  <h3>📈 Incident Rates (TRIR, LTIR)</h3>
  <p>Coming soon...</p>
</div>

<div class="tab-content" id="tab4">
  <h3>📊 Executive Summary (Live from Google Sheets)</h3>
  <iframe src="https://docs.google.com/spreadsheets/d/e/2PACX-1vQUvMV4tvUHnxdhRaAAmmdUpGIcNC4W4MAkbz1kOdXxtsE5813CGN-xiHyYdbmspRoRrWlCzeT6CIq2/pubhtml?gid=566656137&single=true"></iframe>
</div>

<script>
  let fullData = [], currentHeaders = [];

  function showTab(id) {
    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    document.querySelector(`[onclick="showTab('${id}')"]`).classList.add('active');
  }

  function init() {
    const sheetId = '1iMo8gWO3z9UW3f_qInMJ2z5k9h1XiRhGrkLlAZWI-n4';
    const sheetName = 'Master Sheet';
    const apiKey = 'AIzaSyDWcMK3AUseaJT5r3c031n0bSiqpxaz4bo';
    const url = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${encodeURIComponent(sheetName)}?key=${apiKey}`;

    fetch(url)
      .then(res => res.json())
      .then(json => {
        const rows = json.values || [];
        if (rows.length < 2) throw 'No data in sheet';
        const [header, ...dataRows] = rows;
        fullData = dataRows.map(r => {
          return header.reduce((o, h, i) => (o[h] = r[i] || '', o), {});
        });
        currentHeaders = header;
        populateFilters();
        renderTable(fullData);
      })
      .catch(err => alert('⚠️ Failed to load data: ' + err));
  }

  function populateFilters() {
    const cSel = document.getElementById('filterClassification');
    const oSel = document.getElementById('filterOutcome');
    const jSel = document.getElementById('filterJob');
    [cSel,oSel,jSel].forEach(el=>{ while(el.options.length>1) el.remove(1); });
    const seen = {c:new Set(),o:new Set(),j:new Set()};
    fullData.forEach(r => {
      if(r['INCIDENT CLASSIFICATION']) seen.c.add(r['INCIDENT CLASSIFICATION']);
      if(r['INCIDENT OUTCOME']) seen.o.add(r['INCIDENT OUTCOME']);
      if(r['JOB NAME / #']) seen.j.add(r['JOB NAME / #']);
    });
    for(const val of Array.from(seen.c).sort()) cSel.add(new Option(val,val));
    for(const val of Array.from(seen.o).sort()) oSel.add(new Option(val,val));
    for(const val of Array.from(seen.j).sort()) jSel.add(new Option(val,val));
  }

  function applyFilters() {
    const txt = document.getElementById('searchBox').value.toLowerCase();
    const cls = document.getElementById('filterClassification').value;
    const out = document.getElementById('filterOutcome').value;
    const job = document.getElementById('filterJob').value;
    const filtered = fullData.filter(row => {
      const rowText = JSON.stringify(Object.values(row)).toLowerCase();
      return (!txt || rowText.includes(txt)) &&
             (!cls || row['INCIDENT CLASSIFICATION'] === cls) &&
             (!out || row['INCIDENT OUTCOME'] === out) &&
             (!job || row['JOB NAME / #'] === job);
    });
    renderTable(filtered);
  }

  function renderTable(data) {
    const t = document.getElementById('dataTable');
    const th = t.querySelector('thead'), tb = t.querySelector('tbody');
    th.innerHTML = tb.innerHTML = '';
    const hRow = document.createElement('tr');
    currentHeaders.forEach(h=> {
      const cell=document.createElement('th');
      cell.textContent=h;
      hRow.appendChild(cell);
    });
    th.appendChild(hRow);
    data.forEach(r => {
      const tr = document.createElement('tr');
      currentHeaders.forEach(h => {
        const td = document.createElement('td');
        td.textContent = r[h] || '';
        tr.appendChild(td);
      });
      tb.appendChild(tr);
    });
  }

  function exportCSV() {
    const rows = [['"'+currentHeaders.join('","')+'"']];
    document.querySelectorAll('#dataTable tbody tr').forEach(tr=>{
      if(tr.style.display==='none') return;
      const vals = Array.from(tr.children).map(td=>'""'+td.textContent.replace(/"/g,'""')+'""');
      rows.push([vals.join(',')]);
    });
    const blob = new Blob([rows.join('\n')], {type: 'text/csv'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'incident-data.csv';
    a.click();
  }

  window.addEventListener('DOMContentLoaded', init);
</script>

</body>
</html>
