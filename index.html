<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Incident Dashboard</title>
  <style>
    body {
      margin: 0;
      font-family: "Segoe UI", sans-serif;
      background: #f4f6f8;
      color: #333;
    }
    header {
      background: #0077cc;
      color: white;
      padding: 15px 25px;
      font-size: 1.5em;
      font-weight: bold;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .tabs {
      display: flex;
      background: #e9ecef;
      border-bottom: 1px solid #ccc;
    }
    .tab {
      padding: 10px 20px;
      cursor: pointer;
      font-weight: bold;
      border-right: 1px solid #ccc;
    }
    .tab.active {
      background: white;
      border-bottom: none;
    }
    .tab-content {
      display: none;
      padding: 20px;
    }
    .tab-content.active {
      display: block;
    }
    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 15px;
    }
    input, select, button {
      padding: 8px;
      font-size: 14px;
    }
    button {
      background: #007BFF;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background: #0056b3;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 6px 8px;
      text-align: left;
    }
    th {
      background: #f0f0f0;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    tr:nth-child(even) {
      background: #f9f9f9;
    }
  </style>
</head>
<body>

<header>📊 Incident Dashboard</header>

<div class="tabs">
  <div class="tab active" onclick="showTab('tab1')">📋 Incident Table</div>
  <div class="tab" onclick="showTab('tab2')">👷‍♂️ Man Hours</div>
  <div class="tab" onclick="showTab('tab3')">📈 Incident Rates</div>
  <div class="tab" onclick="showTab('tab4')">📑 Summary Table</div>
</div>

<!-- Incident Table -->
<div class="tab-content active" id="tab1">
  <div class="filters">
    <input type="text" id="searchBox" placeholder="Search..." oninput="applyFilters()">
    <select id="filterClassification" onchange="applyFilters()"><option value="">All Classifications</option></select>
    <select id="filterOutcome" onchange="applyFilters()"><option value="">All Outcomes</option></select>
    <select id="filterJob" onchange="applyFilters()"><option value="">All Job #</option></select>
    <button onclick="initIncident()">🔄 Refresh</button>
    <button onclick="exportCSV('incident-data.csv', fullIncidentData)">📥 Export</button>
  </div>
  <table id="incidentTable">
    <thead></thead>
    <tbody></tbody>
  </table>
</div>

<!-- Man Hours -->
<div class="tab-content" id="tab2">
  <h3>👷 Man Hours by Subcontractor</h3>
  <p>Coming soon...</p>
</div>

<!-- Incident Rates -->
<div class="tab-content" id="tab3">
  <h3>📈 Incident Rates (TRIR, LTIR)</h3>
  <p>Coming soon...</p>
</div>

<!-- Summary Table -->
<div class="tab-content" id="tab4">
  <h3>📑 Executive Summary Data</h3>
  <div class="filters">
    <input type="text" id="searchSummary" placeholder="Search summary..." oninput="applySummaryFilter()">
    <button onclick="initSummary()">🔄 Refresh Summary</button>
  </div>
  <table id="summaryTable">
    <thead></thead>
    <tbody></tbody>
  </table>
</div>

<script>
  const SHEET_ID = '1iMo8gWO3z9UW3f_qInMJ2z5k9h1XiRhGrkLlAZWI-n4';
  const API_KEY = 'AIzaSyDWcMK3AUseaJT5r3c031n0bSiqpxaz4bo';

  let fullIncidentData = [], fullSummaryData = [];

  function showTab(id) {
    document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    document.querySelector(`[onclick="showTab('${id}')"]`).classList.add('active');
  }

  function initIncident() {
    fetchSheet('Master Sheet', data => {
      fullIncidentData = data;
      renderTable('incidentTable', fullIncidentData);
      populateIncidentFilters();
    });
  }

  function initSummary() {
    fetchSheet('Summary Table', data => {
      fullSummaryData = data;
      renderTable('summaryTable', fullSummaryData);
    });
  }

  function fetchSheet(sheetName, callback) {
    const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${encodeURIComponent(sheetName)}?key=${API_KEY}`;
    fetch(url)
      .then(r => r.json())
      .then(json => {
        const rows = json.values || [];
        if (rows.length < 1) throw 'empty sheet';
        const [hdr, ...data] = rows;
        const arr = data.map(r => hdr.reduce((o,h,i)=>(o[h]=r[i]||'',o),{}));
        callback(arr);
      })
      .catch(e => alert('Error loading "'+sheetName+'": '+e));
  }

  function renderTable(tableId, data) {
    const table = document.getElementById(tableId);
    const th = table.querySelector('thead'), tb = table.querySelector('tbody');
    th.innerHTML = tb.innerHTML = '';
    if (data.length === 0) {
      tb.innerHTML = '<tr><td colspan="99">No data</td></tr>';
      return;
    }
    const headers = Object.keys(data[0]);
    const hr = document.createElement('tr');
    headers.forEach(h => {
      const cell = document.createElement('th');
      cell.textContent = h;
      hr.appendChild(cell);
    });
    th.appendChild(hr);

    data.forEach(r => {
      const row = document.createElement('tr');
      headers.forEach(h => {
        const td = document.createElement('td');
        td.textContent = r[h];
        row.appendChild(td);
      });
      tb.appendChild(row);
    });
  }

  function applyFilters() {
    const txt = document.getElementById('searchBox').value.toLowerCase();
    const cls = document.getElementById('filterClassification').value;
    const out = document.getElementById('filterOutcome').value;
    const job = document.getElementById('filterJob').value;
    const filtered = fullIncidentData.filter(r => {
      const rowText = JSON.stringify(Object.values(r)).toLowerCase();
      return (!txt || rowText.includes(txt))
          && (!cls || r['INCIDENT CLASSIFICATION'] === cls)
          && (!out || r['INCIDENT OUTCOME'] === out)
          && (!job || r['JOB NAME / #'] === job);
    });
    renderTable('incidentTable', filtered);
  }

  function applySummaryFilter() {
    const txt = document.getElementById('searchSummary').value.toLowerCase();
    const filtered = fullSummaryData.filter(r => JSON.stringify(Object.values(r)).toLowerCase().includes(txt));
    renderTable('summaryTable', filtered);
  }

  function populateIncidentFilters() {
    const c = document.getElementById('filterClassification'),
          o = document.getElementById('filterOutcome'),
          j = document.getElementById('filterJob');
    [c, o, j].forEach(el => { while(el.options.length > 1) el.remove(1); });
    const sets = { c: new Set(), o: new Set(), j: new Set() };
    fullIncidentData.forEach(r => {
      if (r['INCIDENT CLASSIFICATION']) sets.c.add(r['INCIDENT CLASSIFICATION']);
      if (r['INCIDENT OUTCOME']) sets.o.add(r['INCIDENT OUTCOME']);
      if (r['JOB NAME / #']) sets.j.add(r['JOB NAME / #']);
    });
    Array.from(sets.c).sort().forEach(v => c.add(new Option(v, v)));
    Array.from(sets.o).sort().forEach(v => o.add(new Option(v, v)));
    Array.from(sets.j).sort().forEach(v => j.add(new Option(v, v)));
  }

  function exportCSV(fileName, data) {
    if (!data.length) return;
    const headers = Object.keys(data[0]);
    const rows = [headers.join(',')];
    data.forEach(r => {
      rows.push(headers.map(h => `"${(r[h]||'').replace(/"/g, '""')}"`).join(','));
    });
    const blob = new Blob([rows.join('\n')], { type: 'text/csv' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = fileName;
    a.click();
  }

  window.addEventListener('DOMContentLoaded', () => {
    initIncident();
    initSummary();
  });
</script>

</body>
</html>
