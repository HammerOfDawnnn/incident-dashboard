<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Incident Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding:20px; background:#f7f7f7; }
    .controls { display:flex; flex-wrap:wrap; gap:10px; margin-bottom:20px; }
    table { width:100%; border-collapse:collapse; margin-bottom:30px; background:#fff; }
    th, td { border:1px solid #ccc; padding:8px; }
    th { background:#e0e0e0; position:sticky; top:0; }
    tr:nth-child(even){background:#fafafa;}
    @media(max-width:600px){
      table, thead, tbody, th, td, tr {display:block;}
      th, td {width:100%; box-sizing:border-box;}
      th {position:static;}
    }
  </style>
</head>
<body>

<h2>🔧 Incident Dashboard</h2>
<ul class="nav nav-tabs mb-3" id="dashboardTabs" role="tablist">
  <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#incident_tab">Incident Table</button></li>
  <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#manhours_tab">Man Hours</button></li>
  <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#trir_tab">📊 TRIR &amp; LTIR</button></li>
  <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#summary_tab">Summary Table</button></li>
</ul>

<div class="tab-content">
  <!-- Incident Table -->
  <div class="tab-pane fade show active" id="incident_tab">
    <div class="controls">
      <input type="text" id="search" class="form-control" placeholder="🔍 Search…" oninput="applyIncidentFilters()">
      <select id="filterClassification" class="form-select" onchange="applyIncidentFilters()"><option value="">All Classifications</option></select>
      <select id="filterOutcome" class="form-select" onchange="applyIncidentFilters()"><option value="">All Outcomes</option></select>
      <select id="filterJob" class="form-select" onchange="applyIncidentFilters()"><option value="">All Job #</option></select>
      <button class="btn btn-primary" onclick="loadIncident()">🔄 Refresh</button>
      <button class="btn btn-secondary" onclick="exportCSV('dataTable','incidents.csv')">📥 Export CSV</button>
    </div>
    <table id="dataTable"><thead></thead><tbody></tbody></table>
  </div>

  <!-- Man Hours -->
  <div class="tab-pane fade" id="manhours_tab">
    <div class="controls">
      <button class="btn btn-primary" onclick="loadSheet('manHoursTable','MAN HOURS')">🔄 Refresh Man Hours</button>
      <button class="btn btn-secondary" onclick="exportCSV('manHoursTable','man-hours.csv')">📥 Export CSV</button>
    </div>
    <table id="manHoursTable"><thead></thead><tbody></tbody></table>
  </div>

  <!-- 📊 TRIR & LTIR -->
  <div class="tab-pane fade" id="trir_tab">
    <div class="controls">
      <button class="btn btn-primary" onclick="loadSheet('trirTable','TRIR & LTIR')">🔄 Refresh TRIR & LTIR</button>
      <button class="btn btn-secondary" onclick="exportCSV('trirTable','trir_ltir.csv')">📥 Export CSV</button>
    </div>
    <table id="trirTable"><thead></thead><tbody></tbody></table>
  </div>

  <!-- Summary Table -->
  <div class="tab-pane fade" id="summary_tab">
    <div class="controls">
      <button class="btn btn-primary" onclick="loadSheet('summaryTable','Summary Table')">🔄 Refresh Summary</button>
      <button class="btn btn-secondary" onclick="exportCSV('summaryTable','summary.csv')">📥 Export CSV</button>
    </div>
    <table id="summaryTable"><thead></thead><tbody></tbody></table>
  </div>
</div>

<script>
  const SHEET_ID = '1iMo8gWO3z9UW3f_qInMJ2z5k9h1XiRhGrkLlAZWI-n4';

  // Generic loader
  function loadSheet(tableId, sheetName) {
    const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${getGid(sheetName)}&nocache=${Date.now()}`;
    Papa.parse(url, {
      download: true, header: true, skipEmptyLines: true,
      complete: res => renderTable(tableId, res.data),
      error: () => alert(`⚠️ Failed loading "${sheetName}"`)
    });
  }

  function getGid(name) {
    const map = {
      'Master Sheet': '0',
      'MAN HOURS': '<use actual gid for MAN HOURS tab>',
      'TRIR & LTIR': '1103432243',
      'Summary Table': '<use actual gid for Summary Tab>'
    };
    return map[name];
  }

  // Incident-specific logic
  function loadIncident() {
    loadSheet('dataTable', 'Master Sheet');
    setTimeout(() => {
      const data = window.fullIncidentData = window.lastData || [];
      populateFilters(data);
      applyIncidentFilters();
    }, 500);
  }

  function populateFilters(data) {
    const sets = {cls: new Set(), out: new Set(), job: new Set()};
    data.forEach(r => {
      if(r['INCIDENT CLASSIFICATION']) sets.cls.add(r['INCIDENT CLASSIFICATION']);
      if(r['INCIDENT OUTCOME']) sets.out.add(r['INCIDENT OUTCOME']);
      if(r['JOB NAME / #']) sets.job.add(r['JOB NAME / #']);
    });
    fillSelect('filterClassification', sets.cls);
    fillSelect('filterOutcome', sets.out);
    fillSelect('filterJob', sets.job);
  }

  function fillSelect(id, set) {
    const sel = document.getElementById(id);
    sel.querySelectorAll('option:not([value=""])').forEach(o => o.remove());
    Array.from(set).sort().forEach(v => sel.add(new Option(v, v)));
  }

  function applyIncidentFilters() {
    const txt = (document.getElementById('search').value || '').toLowerCase();
    const cls = document.getElementById('filterClassification').value;
    const out = document.getElementById('filterOutcome').value;
    const job = document.getElementById('filterJob').value;
    document.querySelectorAll('#dataTable tbody tr').forEach(tr => {
      const txtRow = tr.innerText.toLowerCase();
      const ok =
        (!txt || txtRow.includes(txt)) &&
        (!cls || tr.innerText.includes(cls)) &&
        (!out || tr.innerText.includes(out)) &&
        (!job || tr.innerText.includes(job));
      tr.style.display = ok ? '' : 'none';
    });
  }

  function renderTable(tableId, data) {
    window.lastData = data; // store for filters
    const t = document.getElementById(tableId);
    const th = t.tHead || t.createTHead();
    const tb = t.tBodies[0] || t.createTBody();
    th.innerHTML = tb.innerHTML = '';
    if(!data.length) return;
    const hdrs = Object.keys(data[0]);
    const hr = th.insertRow();
    hdrs.forEach(h => hr.insertCell().outerHTML = `<th>${h}</th>`);
    data.forEach(r => {
      const tr = tb.insertRow();
      hdrs.forEach(h => tr.insertCell().textContent = r[h] || '');
    });
  }

  function exportCSV(tableId, filename) {
    const rows = [];
    const table = document.getElementById(tableId);
    Array.from(table.querySelectorAll('thead tr, tbody tr')).forEach(tr => {
      const cols = Array.from(tr.cells).map(td => `"${td.innerText.replace(/"/g,'""')}"`);
      rows.push(cols.join(','));
    });
    const blob = new Blob([rows.join('\n')], {type:'text/csv'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
  }

  document.addEventListener('DOMContentLoaded', () => {
    loadIncident();
    loadSheet('manHoursTable', 'MAN HOURS');
    loadSheet('trirTable', 'TRIR & LTIR');
    loadSheet('summaryTable', 'Summary Table');
  });
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
